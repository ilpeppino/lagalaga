# LagaLaga Database Schema Documentation

## Overview

**Project**: Lagalaga
**Project ID**: zbsvxhwilhkpabyybjdk
**Region**: eu-west-1
**Status**: ACTIVE_HEALTHY
**PostgreSQL Version**: 17.6.1.063
**Database Engine**: PostgreSQL 17

**Last Updated**: 2026-02-12

---

## Table of Contents

1. [Tables](#tables)
2. [Relationships](#relationships)
3. [Indexes](#indexes)
4. [Custom Types (Enums)](#custom-types-enums)
5. [Functions](#functions)
6. [Triggers](#triggers)
7. [Extensions](#extensions)
8. [Migration History](#migration-history)

---

## Tables

### `app_users`

Stores user accounts linked to Roblox OAuth.

**RLS Enabled**: Yes
**Row Count**: 1

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | PRIMARY KEY, UNIQUE |
| `roblox_user_id` | varchar | No | - | UNIQUE |
| `roblox_username` | varchar | No | - | - |
| `roblox_display_name` | varchar | Yes | - | - |
| `roblox_profile_url` | text | Yes | - | - |
| `created_at` | timestamptz | No | now() | - |
| `updated_at` | timestamptz | No | now() | - |
| `last_login_at` | timestamptz | Yes | - | - |

**Foreign Key References**:
- Referenced by `sessions.host_id`
- Referenced by `session_participants.user_id`
- Referenced by `session_invites.created_by`

---

### `games`

Stores information about Roblox games/places.

**RLS Enabled**: Yes
**Row Count**: 1

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `place_id` | bigint | No | - | PRIMARY KEY |
| `canonical_web_url` | text | No | - | - |
| `canonical_start_url` | text | No | - | - |
| `game_name` | text | Yes | - | - |
| `game_description` | text | Yes | - | - |
| `thumbnail_url` | text | Yes | - | - |
| `max_players` | integer | Yes | - | - |
| `creator_id` | bigint | Yes | - | - |
| `creator_name` | text | Yes | - | - |
| `created_at` | timestamptz | Yes | now() | - |
| `updated_at` | timestamptz | Yes | now() | - |

**Foreign Key References**:
- Referenced by `sessions.place_id`

---

### `roblox_experience_cache`

Caches Roblox experience metadata resolved from pasted URLs.

**RLS Enabled**: No
**Row Count**: 0

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | bigint | No | generated by identity | PRIMARY KEY |
| `platform_key` | text | No | `'roblox'` | - |
| `url` | text | No | - | UNIQUE |
| `place_id` | text | No | - | - |
| `universe_id` | text | Yes | - | - |
| `name` | text | Yes | - | - |
| `updated_at` | timestamptz | No | now() | - |
| `created_at` | timestamptz | No | now() | - |

**Notes**:
- Used by backend endpoint `POST /roblox/resolve-experience`
- Backend TTL policy: 24 hours (enforced in application logic)

---

### `sessions`

Stores gaming session information.

**RLS Enabled**: Yes
**Row Count**: 3

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | PRIMARY KEY |
| `place_id` | bigint | No | - | FK → games.place_id |
| `host_id` | uuid | No | - | FK → app_users.id |
| `title` | text | No | - | - |
| `description` | text | Yes | - | - |
| `visibility` | session_visibility | No | 'public' | ENUM |
| `status` | session_status | No | 'scheduled' | ENUM |
| `max_participants` | integer | No | 10 | CHECK > 0 |
| `scheduled_start` | timestamptz | Yes | - | - |
| `scheduled_end` | timestamptz | Yes | - | - |
| `original_input_url` | text | No | - | - |
| `normalized_from` | text | No | - | - |
| `created_at` | timestamptz | Yes | now() | - |
| `updated_at` | timestamptz | Yes | now() | - |

**Foreign Key References**:
- `place_id` → `games.place_id`
- `host_id` → `app_users.id`
- Referenced by `session_participants.session_id`
- Referenced by `session_invites.session_id`

---

### `session_participants`

Manages participants in gaming sessions.

**RLS Enabled**: Yes
**Row Count**: 3

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `session_id` | uuid | No | - | PRIMARY KEY (composite), FK → sessions.id |
| `user_id` | uuid | No | - | PRIMARY KEY (composite), FK → app_users.id |
| `role` | participant_role | No | 'member' | ENUM |
| `state` | participant_state | No | 'joined' | ENUM |
| `joined_at` | timestamptz | Yes | now() | - |
| `left_at` | timestamptz | Yes | - | - |

**Foreign Key References**:
- `session_id` → `sessions.id`
- `user_id` → `app_users.id`

**Composite Primary Key**: (`session_id`, `user_id`)

---

### `session_invites`

Manages invite codes for gaming sessions.

**RLS Enabled**: Yes
**Row Count**: 3

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | PRIMARY KEY |
| `session_id` | uuid | No | - | FK → sessions.id |
| `created_by` | uuid | No | - | FK → app_users.id |
| `invite_code` | text | No | - | UNIQUE |
| `max_uses` | integer | Yes | - | CHECK > 0 OR NULL |
| `uses_count` | integer | Yes | 0 | CHECK >= 0 |
| `expires_at` | timestamptz | Yes | - | - |
| `created_at` | timestamptz | Yes | now() | - |

**Foreign Key References**:
- `session_id` → `sessions.id`
- `created_by` → `app_users.id`

---

### `platforms`

Stores supported gaming platforms.

**RLS Enabled**: Yes
**Row Count**: 3

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | text | No | - | PRIMARY KEY |
| `name` | text | No | - | - |
| `icon_url` | text | Yes | - | - |
| `deep_link_scheme` | text | Yes | - | - |
| `created_at` | timestamptz | Yes | now() | - |

**Foreign Key References**:
- Referenced by `user_platforms.platform_id`

---

### `user_platforms`

Links users to their platform accounts.

**RLS Enabled**: Yes
**Row Count**: 0

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `user_id` | uuid | No | - | PRIMARY KEY (composite), FK → auth.users.id |
| `platform_id` | text | No | - | PRIMARY KEY (composite), FK → platforms.id |
| `platform_user_id` | text | No | - | - |
| `platform_username` | text | Yes | - | - |
| `platform_display_name` | text | Yes | - | - |
| `platform_avatar_url` | text | Yes | - | - |
| `is_primary` | boolean | Yes | false | - |
| `verified_at` | timestamptz | Yes | - | - |
| `created_at` | timestamptz | Yes | now() | - |
| `updated_at` | timestamptz | Yes | now() | - |

**Foreign Key References**:
- `user_id` → `auth.users.id`
- `platform_id` → `platforms.id`

**Composite Primary Key**: (`user_id`, `platform_id`)
**Unique Constraint**: (`platform_id`, `platform_user_id`)

---

## Relationships

### Entity Relationship Diagram

```
app_users (1) ----< (many) sessions [host_id]
app_users (1) ----< (many) session_participants [user_id]
app_users (1) ----< (many) session_invites [created_by]

games (1) ----< (many) sessions [place_id]

sessions (1) ----< (many) session_participants [session_id]
sessions (1) ----< (many) session_invites [session_id]

platforms (1) ----< (many) user_platforms [platform_id]
auth.users (1) ----< (many) user_platforms [user_id]
```

### Foreign Key Constraints

| Table | Column | References | Constraint Name |
|-------|--------|------------|-----------------|
| `session_invites` | `created_by` | `app_users.id` | `fk_session_invites_created_by` |
| `session_invites` | `session_id` | `sessions.id` | `session_invites_session_id_fkey` |
| `session_participants` | `session_id` | `sessions.id` | `session_participants_session_id_fkey` |
| `session_participants` | `user_id` | `app_users.id` | `fk_session_participants_user` |
| `sessions` | `host_id` | `app_users.id` | `fk_sessions_host_user` |
| `sessions` | `place_id` | `games.place_id` | `sessions_place_id_fkey` |
| `user_platforms` | `platform_id` | `platforms.id` | `user_platforms_platform_id_fkey` |

---

## Indexes

### Performance Indexes

#### `app_users` Table
- `app_users_pkey` (PRIMARY KEY): UNIQUE btree (id)
- `app_users_roblox_user_id_key` (UNIQUE): btree (roblox_user_id)
- `idx_app_users_roblox_user_id`: btree (roblox_user_id)

#### `games` Table
- `games_pkey` (PRIMARY KEY): UNIQUE btree (place_id)
- `idx_games_canonical_url`: btree (canonical_web_url)
- `idx_games_creator`: btree (creator_id)
- `idx_games_name`: btree (game_name)
- `idx_games_thumbnail_url`: btree (thumbnail_url) WHERE thumbnail_url IS NOT NULL

#### `roblox_experience_cache` Table
- `roblox_experience_cache_pkey` (PRIMARY KEY): UNIQUE btree (id)
- `roblox_experience_cache_url_key` (UNIQUE): btree (url)
- `idx_roblox_experience_cache_place_id`: btree (place_id)
- `idx_roblox_experience_cache_updated_at`: btree (updated_at DESC)

#### `sessions` Table
- `sessions_pkey` (PRIMARY KEY): UNIQUE btree (id)
- `idx_sessions_created_at`: btree (created_at DESC)
- `idx_sessions_host`: btree (host_id)
- `idx_sessions_host_status`: btree (host_id, status) WHERE status IN ('scheduled', 'active')
- `idx_sessions_place`: btree (place_id)
- `idx_sessions_place_status`: btree (place_id, status) WHERE status IN ('active', 'scheduled')
- `idx_sessions_scheduled_start`: btree (scheduled_start)
- `idx_sessions_status`: btree (status)
- `idx_sessions_status_scheduled`: btree (status, scheduled_start DESC NULLS LAST) WHERE status IN ('active', 'scheduled')
- `idx_sessions_visibility`: btree (visibility)

#### `session_participants` Table
- `session_participants_pkey` (PRIMARY KEY): UNIQUE btree (session_id, user_id)
- `idx_participants_session_state`: btree (session_id, state)
- `idx_participants_user`: btree (user_id)
- `idx_session_participants_session_id`: btree (session_id)
- `idx_session_participants_session_state`: btree (session_id, state) WHERE state = 'joined'
- `idx_session_participants_user_state`: btree (user_id, state) WHERE state = 'joined'

#### `session_invites` Table
- `session_invites_pkey` (PRIMARY KEY): UNIQUE btree (id)
- `session_invites_invite_code_key` (UNIQUE): btree (invite_code)
- `idx_invites_code`: UNIQUE btree (invite_code)
- `idx_invites_expires`: btree (expires_at)
- `idx_invites_session`: btree (session_id)
- `idx_session_invites_code`: btree (invite_code)
- `idx_session_invites_expired`: btree (expires_at) WHERE expires_at IS NOT NULL
- `idx_session_invites_session_id`: btree (session_id)

#### `platforms` Table
- `platforms_pkey` (PRIMARY KEY): UNIQUE btree (id)

#### `user_platforms` Table
- `user_platforms_pkey` (PRIMARY KEY): UNIQUE btree (user_id, platform_id)
- `user_platforms_platform_id_platform_user_id_key` (UNIQUE): btree (platform_id, platform_user_id)
- `idx_user_platforms_platform_user`: btree (platform_id, platform_user_id)
- `idx_user_platforms_user_id`: btree (user_id)

---

## Custom Types (Enums)

### `participant_role`
User role within a session.

**Values**: `host`, `member`

---

### `participant_state`
Current state of a participant in a session.

**Values**: `invited`, `joined`, `left`, `kicked`

---

### `session_status`
Current status of a gaming session.

**Values**: `scheduled`, `active`, `completed`, `cancelled`

---

### `session_visibility`
Visibility/access level of a session.

**Values**: `public`, `friends`, `invite_only`

---

## Functions

### `list_sessions_optimized`

**Type**: Function
**Returns**: TABLE

Optimized query for listing sessions with game information and participant counts. Eliminates N+1 query problems by joining all necessary data in a single query.

**Parameters**:
- `p_status` (text, optional): Filter by session status
- `p_visibility` (text, optional): Filter by visibility
- `p_place_id` (bigint, optional): Filter by game place ID
- `p_host_id` (uuid, optional): Filter by host user ID
- `p_limit` (integer, default: 20): Maximum results to return
- `p_offset` (integer, default: 0): Pagination offset

**Returns**: Session details with joined game information and participant count

---

### `list_user_planned_sessions_optimized`

**Type**: Function
**Returns**: TABLE

Optimized query for listing sessions where a specific user is a participant. Similar to `list_sessions_optimized` but filters by participant user ID.

**Parameters**:
- `p_user_id` (uuid, required): User ID to filter by
- `p_limit` (integer, default: 20): Maximum results to return
- `p_offset` (integer, default: 0): Pagination offset

**Returns**: Session details with joined game information and participant count

---

### `update_games_updated_at`

**Type**: Trigger function
**Returns**: trigger

Updates the `updated_at` timestamp on the `games` table when a row is modified.

---

### `update_updated_at_column`

**Type**: Trigger function
**Returns**: trigger

Generic trigger function to update the `updated_at` timestamp on any table when a row is modified.

---

## Triggers

| Trigger Name | Table | Timing | Events | Function |
|--------------|-------|--------|--------|----------|
| `games_updated_at_trigger` | `games` | BEFORE | UPDATE | `update_games_updated_at` |
| `update_games_updated_at` | `games` | BEFORE | UPDATE | `update_updated_at_column` |
| `update_sessions_updated_at` | `sessions` | BEFORE | UPDATE | `update_updated_at_column` |
| `update_user_platforms_updated_at` | `user_platforms` | BEFORE | UPDATE | `update_updated_at_column` |

---

## Extensions

### Installed Extensions

| Extension | Schema | Version | Description |
|-----------|--------|---------|-------------|
| `pgcrypto` | extensions | 1.3 | Cryptographic functions |
| `pg_stat_statements` | extensions | 1.11 | Track planning and execution statistics of all SQL statements |
| `supabase_vault` | vault | 0.3.1 | Supabase Vault Extension |
| `uuid-ossp` | extensions | 1.1 | Generate universally unique identifiers (UUIDs) |
| `pg_graphql` | graphql | 1.5.11 | GraphQL support for PostgreSQL |
| `plpgsql` | pg_catalog | 1.0 | PL/pgSQL procedural language |

### Available Extensions (Not Installed)

Over 80 additional extensions are available including:
- PostGIS (geography and geometry)
- pg_cron (job scheduler)
- vector (vector data type for AI/ML)
- http (HTTP client)
- And many more...

---

## Migration History

Migrations are tracked and applied in order. The following migrations have been applied:

| Version | Name | Description |
|---------|------|-------------|
| `20260207172512` | `001_core_schema` | Initial database schema with core tables |
| `20260211135258` | `complete_rls_policies` | Complete Row Level Security policies |
| `20260211135359` | `enable_rls_policies` | Enable RLS on all tables |
| `20260211223803` | `add_thumbnail_to_games` | Add thumbnail_url field to games table |
| `20260212190000` | `add_roblox_experience_cache` | Add Roblox experience cache table for URL metadata resolution |

---

## Security

### Row Level Security (RLS)

All tables in the `public` schema have RLS enabled:
- ✅ `app_users`
- ✅ `games`
- ✅ `sessions`
- ✅ `session_participants`
- ✅ `session_invites`
- ✅ `platforms`
- ✅ `user_platforms`
- ❌ `roblox_experience_cache` (service-role backend cache table)

RLS policies control data access based on the authenticated user's context, ensuring users can only access data they're authorized to see.

---

## Performance Optimizations

Recent performance improvements include:

1. **Composite Indexes**: Multi-column indexes on frequently queried combinations (e.g., `idx_sessions_host_status`, `idx_sessions_place_status`)

2. **Partial Indexes**: Indexes with WHERE clauses to reduce index size and improve query performance for common filters (e.g., active/scheduled sessions only)

3. **Optimized Functions**: `list_sessions_optimized()` and `list_user_planned_sessions_optimized()` eliminate N+1 query problems by using JOINs and CTEs

4. **Strategic Index Coverage**: Indexes on foreign keys, frequently filtered columns (status, visibility), and sort columns (created_at, scheduled_start)

---

## Notes

- All timestamps use `timestamptz` (timestamp with time zone) for proper timezone handling
- UUID primary keys are used for user-facing tables to prevent enumeration attacks
- Bigint is used for `place_id` to match Roblox's game ID format
- Composite primary keys are used for junction tables (`session_participants`, `user_platforms`)
- Check constraints ensure data integrity (e.g., `max_participants > 0`, `uses_count >= 0`)
- Default values are set for commonly-used fields to reduce application logic
